version: "3.6"
services:
  broker:
    build:
      context: .
      dockerfile: docker/broker/Dockerfile
    environment:
      PORT: 50501
  signaling:
    build:
      context: .
      dockerfile: docker/signaling/Dockerfile
    environment:
      GAMESERVER_ADDR: "gameagent:50501"
      PORT: 8080
      GRPC_PORT: 50502
    ports:
      - 8080:8080
  gameagent:
    build:
      context: .
      dockerfile: docker/gameagent/Dockerfile
  streamer:
    build:
      context: .
      dockerfile: docker/streamer/Dockerfile
    volumes:
      - x11socket:/tmp/.X11-unix/
  game:
    command: wine /microkiri/microkiri.exe
    build: ./docker/game
    environment: 
      PULSE_SERVER: gameagent:4713
    security_opt:
      - seccomp:unconfined # to avoid clock_getres() failure with EPERM on i386 pulseaudio
    volumes:
      - ./game/microkiri:/microkiri
      - x11socket:/tmp/.X11-unix/
    ports:
      - 5900:5900 # VNC for debugging

volumes:
  x11socket: